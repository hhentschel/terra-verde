<!-- Template: {{ _self }}.twig -->
{# Allow passing of cart into partial #}
{% set cart = cart is not defined ? craft.commerce.carts.cart : cart %}

{% set addressId = craft.app.request.queryParam('addressId') %}
{% set redirect = craft.app.request.queryParam('redirect') %}
{% set countryCode = craft.app.request.queryParam('countryCode') %}

{% if not address is defined %}
  {% if addressId %}
    {% set address = collect(currentUser.addresses).firstWhere('id', addressId) %}
    {% if not address %}
      {% exit 404 %}
    {% endif %}
  {% else %}
    {% set address = create({
      class: 'craft\\elements\\Address',
      ownerId: currentUser.id,
      countryCode: countryCode ?? 'CH'
    }) %}
  {% endif %}
{% endif %}

{# {% set addresses = craft.commerce.customers.customer.addresses %} #}

{% set discount = craft.commerce.discounts.getDiscountByCode(cart.couponCode) %}

{% set showShippingAddress = showShippingAddress ?? false %}
{% set showShippingMethod = showShippingMethod ?? false %}

<div class="checkout__box checkout__box-summary">
  <h2 class="heading heading--2 heading--no-margin-top">
    Bestellübersicht
  </h2>

  Are the addresses the same: {{ cart.hasMatchingAddresses() ? 'Yes' : 'No' }}

  {% if showShippingAddress %}
    <div class="checkout__box--adresses">

      <div class="checkout__box--adresses-single">

        <h4 class="heading heading--4 checkout__box--subheading">
          Versandadresse
        </h4>
        {% if cart.shippingAddress %}
          <div class="address-select js-address-select border-0">
            <ul class="address-list">
              {% if cart.shippingAddress.organization %}
                <li class="address-list__item">{{ cart.shippingAddress.organization }}</li>
              {% endif %}
              <li class="address-list__item">{{ cart.shippingAddress.firstName }}</li>
              <li class="address-list__item">{{ cart.shippingAddress.lastName }}</li>
              <li class="address-list__item">{{ cart.shippingAddress.postalCode }}</li>
              <li class="address-list__item">{{ cart.shippingAddress.addressLine1 }}</li>
              {% if cart.shippingAddress.addressLine2 %}
                <li class="address-list__item">{{ cart.shippingAddress.addressLine2 }}</li>
              {% endif %}
              {% if cart.shippingAddress.locality %}
                <li class="address-list__item">{{ cart.shippingAddress.locality }}</li>
              {% endif %}
            </ul>
          </div>

        {% else %}
          <p>{{ 'No shipping address selected.'|t }}</p>
        {% endif %}
      </div>

      <div class="checkout__box--adresses-single">
        {% if cart.billingAddress %}
          <h4 class="heading heading--4 checkout__box--subheading">
            Rechnungsadresse
          </h4>
          <div class="js-address-select border-0">
            <ul class="address-list">
              {% if cart.billingAddress.organization %}
                <li class="address-list__item">{{ cart.billingAddress.organization }}</li>
              {% endif %}
              <li class="address-list__item">{{ cart.billingAddress.firstName }}</li>
              <li class="address-list__item">{{ cart.billingAddress.lastName }}</li>
              <li class="address-list__item">{{ cart.billingAddress.postalCode }}</li>
              <li class="address-list__item">{{ cart.billingAddress.addressLine1 }}</li>
              {% if cart.billingAddress.addressLine2 %}
                <li class="address-list__item">{{ cart.billingAddress.addressLine2 }}</li>
              {% endif %}
              {% if cart.billingAddress.locality %}
                <li class="address-list__item">{{ cart.billingAddress.locality }}</li>
              {% endif %}
            </ul>
          </div>
        {% else %}
          <p>{{ 'No billing address selected.'|t }}</p>
        {% endif %}
      </div>

    </div>

    <div class="checkout__box--button-change">
      <a href="{{ url('/shop/checkout/addresses') }}" class="button--small button button--primary">
        {{- 'Adressen ändern'|t -}}
      </a>
    </div>
  {% endif %}


  {% if showShippingMethod %}
    {% if cart.shippingMethod %}
      <div class="checkout__box checkout__box--section">
        <h4 class="font-semibold mt-3">
          Versandart
        </h4>

        <div>
          {{ cart.shippingMethod.name }}
        </div>
      </div>
    {% endif %}
  {% endif %}

  <h4 class="heading layout-helper__margin-top--xxs">
    Artikel
  </h4>
  {% for item in cart.lineItems %}
    <div class="flex w-full justify-between">
      <div class="flex justify-between mr-3 overflow-hidden items-center">
        <div class="truncate">
          {% if item.qty %}
            {{ item.qty }}&times;
          {% endif %}
          {{ item.description }}
        </div>
      </div>

      {% if
        item.options.giftWrapped is defined
        or item.options.giftNote is defined %}
        <div class="">
          {{ item.total|currency(cart.currency) }}
        </div>
      {% else %}
        <div>
          {{ item.subtotal|currency(cart.currency) }}
        </div>
      {% endif %}
    </div>
    {% if item.note %}
      <div class="mt-1 flex">
        <div class="pr-2 uppercase">
          Notiz
        </div>
        <div>
          {{ item.note }}
        </div>
      </div>
    {% endif %}

  {% else %}
    <div class="mb-3">
      <p>
        Der Warenkorb ist leer, <a class="underline text-blue-500"
                                   href="{{ url('shop/produkte') }}">
          etwas hinzufügen
        </a>.
      </p>
    </div>
  {% endfor %}

  <div class="summary__price summary__price--line">
    <div class="summary__price--title">
      Zwischensumme:
    </div>
    <div class="summary__price--number">
      {{ cart.itemSubTotal|commerceCurrency(cart.currency) }}
    </div>
  </div>


  <div class="checkout__box checkout__box--section">
    <div class="checkout__box--adjustments-detail">

      {% for adjustment in cart.adjustments %}
        <div class="summary__price">
          <div class="summary__price--title">
            {% if adjustment.type == "shipping" %}
              <span class="special-font-size">Versand:</span>
            {% elseif adjustment.type == "tax" %}
              <span>Steuer:</span>

            {% elseif adjustment.name == "Rundung" %}
              <span>Rundung:</span>

            {% else %}
              <span>{{ adjustment.name }}</span>
            {% endif %}
          </div>
          <div {% if adjustment.type == "shipping" %}class="special-font-size" {% endif %}>
            {{ adjustment.amount|commerceCurrency(cart.currency) }}
          </div>
        </div>
      {% endfor %}
    </div>


    {% if cart.totalDiscount < 0 %}
      <div class="summary__price">
        <div class="summary__price--title">
          Rabatt Artikel gesamt:
        </div>
        <div>
          {{ (cart.totalDiscount * 1)|commerceCurrency(cart.currency) }}
        </div>
      </div>
    {% endif %}

    <div class="summary__price">
      <div class="summary__price--title summary__price--title-bold">
        Endsumme:
      </div>
      <div class="summary__price--number summary__price--number-bold">
        {{ cart.totalPrice|commerceCurrency(cart.currency) }}
      </div>
    </div>

  </div>
  {% if
    cart.currency != cart.paymentCurrency
    and cart.totalPrice == cart.getOutstandingBalance() %}
    <div class="mt-1 flex w-full justify-end">
      <div class="text-gray-600 pr-2">
        Zahlung {{ cart.paymentCurrency }}:
      </div>
      <div>
        {{ cart.totalPrice|commerceCurrency(cart.paymentCurrency, convert = true) }}
      </div>
    </div>
  {% endif %}
</div>
