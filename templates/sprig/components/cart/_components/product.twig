{% set product = craft.products.id(productId).one() %}
{% set variant = craft.variants.id(variantId).one() %}

{% set lastProductId = lastProductId ?? 0 %}
{% set purchasableId = purchasableId ?? 0 %}

{% set addedToCart = success is defined %}

{% if cart is not defined %}
  {% set cart = craft.commerce.carts.cart %}
{% endif %}


 {% if sprig.isRequest %}
   <script>
     htmx.trigger('#cartsize', 'refresh');
   </script>
 {% endif %}

{# {% for product in products %}
   {% for variant in product.getVariants() %}
     {{ sprig('sprig/components/cart/_components/productitem', {variantId : variant.id, productId : product.id}, {'class': 'shop-list__item'}) }}
   {% endfor %}
 {% endfor %} #}
{# Eager Load Images
https://craftcms.stackexchange.com/questions/39033/eager-loading-of-variant-images #}
{% do craft.app.elements.eagerLoadElements(
  className(product),
  [product],
  [
    ['articleImage', { withTransforms: ['productListing'] }],
    ['articleCategoriesStatus'],
    ['articleCategoriesGift'],
  ]
) %}

<a class="shop-list__link" href="{{ product.url }}">
  {% if variant.onSale %}
    <div class="onsale">
    </div>
  {% endif %}

  {% if product.articleCategoriesStatus|contains('id', '10745') %}
    <div class="newproduct">
    </div>
  {% endif %}

  {% if variant.hasstock == false %}
    <div class="oos">
      <span class="oos-message">zurzeit nicht lieferbar</span>
    </div>
  {% endif %}
  <div class="shop-list__image">
    {% if product.articleCategoriesGift|contains('id', '10887') or product.articleCategoriesGift|contains('id', '10888') or product.articleCategoriesGift|contains('id', '10889') or product.articleCategoriesGift|contains('id', '10890') or product.articleCategoriesGift|contains('id', '10891') or product.articleCategoriesGift|contains('id', '10892') %}
      <span class="shop-list__item--infohover">Zusatzoptionen anschauen</span>
    {% else %}
      <span class="shop-list__item--infohover">Informationen anschauen</span>
    {% endif %}

    {% set transform = transformation|default('productListing') %}
    {% set img = product.articleImage.one() ?? null %}
    {% set img = product.articleImage[0] ?? null %}

    {% if img is defined %}
      {% include '_components/_content-elements/image-product'
        with {
        image: img,
        transform: transform
      } %}
    {% endif %}

  </div>

  <div class="shop-list__text">
    <h3 class="layout-helper__margin-vertical--none">
      {{ product.title }}
    </h3>
    <div class="shop-list__text--pricevolume">
      {% if variant.articleVolume %}
        <span class="shop-list__volume">
        - {{ variant.articleVolume }}{{ variant.articleVolumeUnit }} -
      </span>
      {% endif %}

      {% include '/shop/produkte/_includes/prices.twig' %}

    </div>
  </div>

</a>

<form class="js-form">
  {{ successMessageInput('Produkt wurde zum Warenkorb hinzugef√ºgt.') }}


  <div class="shop-list__item-cart">
    <div class="item-cart__qty-btn" id="addtocart-{{ variant.id }}">


      {% if variant.stock > 0 or variant.hasUnlimitedStock %}

        <input class="input input-xsmall"
               name="qty"
               type="number"
               step="1"
          {% if currentUser %}
            {% if currentUser.isInGroup('userGroupRetail') %}
              value="{{ product.artikelMinOrderSize }}"
              min="{{ product.artikelMinOrderSize }}"
              placeholder="{{ product.artikelMinOrderSize }}"
            {% else %}
              value="1"
              min="1"
            {% endif %}
          {% else %}
            value="1"
            min="1"
          {% endif %}
        >

        {% if sprig.isInclude %}
          <button class="button--primary">

            <svg height="20" width="40" class="loader">
              <circle class="dot" cx="10" cy="10" r="3" style="fill:white;"/>
              <circle class="dot" cx="20" cy="10" r="3" style="fill:white;"/>
              <circle class="dot" cx="30" cy="10" r="3" style="fill:white;"/>
            </svg>
            <style>
              @keyframes blink {
                50% {
                  fill: transparent
                }
              }

              .dot {
                animation: 1s blink infinite;
                fill: white;
              }

              .dot:nth-child(2) {
                animation-delay: 250ms
              }

              .dot:nth-child(3) {
                animation-delay: 500ms
              }

              .loader {
                color: white;
              }
            </style>

          </button>
        {% else %}

          {# {{ sprig ('sprig/components/filters/_components/indicator-addtocart') }} #}
          {# {% include 'sprig/components/filters/_components/indicator-addtocart' %} #}
          {# {{ sprig(
          'sprig/components/filters/_components/indicator-addtocart',
          {},
          {
            id: '',
            's-trigger': 'refresh'
          }
        ) }} #}

          <button sprig
                  s-action="commerce/cart/update-cart"
                  s-method="post"
                  s-val:purchasable-id="{{ variant.id }}"
                  s-replace="#addtocart-{{ variant.id }}
          class=" button--primary {% if addedToCart and purchasableId == variant.id %}button--success {% endif %}
                  text-center">
          {% include 'sprig/components/filters/_components/indicator-addtocart' %}
          {% if addedToCart and purchasableId == variant.id %}
            <svg class="icon--check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd"/>
            </svg>
            <span class="button--primary__text">Im Warenkorb</span>

          {% else %}
            <span class="button--primary__text">
         In den Warenkorb

      </span>
          {% endif %}
          </button>

        {% endif %}


      {% else %}
        <a class="button button--primary button--primary-bis button--small" href="{{ product.url }}">
          <span>Benachrichtigen Sie mich</span>
        </a>
      {% endif %}
      

    </div>

  </div>

</form>


